-- Fix historical_prices table structure to support OHLC chart data
USE stock_simulation;

-- Drop existing table and recreate with proper structure
DROP TABLE IF EXISTS historical_prices;

-- Create historical_prices table with OHLC structure
CREATE TABLE historical_prices (
    id INT AUTO_INCREMENT PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,
    date DATE NOT NULL,
    open DECIMAL(10,2) NOT NULL,
    high DECIMAL(10,2) NOT NULL,
    low DECIMAL(10,2) NOT NULL,
    close DECIMAL(10,2) NOT NULL,
    volume BIGINT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (symbol) REFERENCES stocks(symbol) ON DELETE CASCADE,
    INDEX idx_symbol_date (symbol, date),
    INDEX idx_date (date),
    UNIQUE KEY unique_symbol_date (symbol, date)
);

-- Insert sample OHLC data for existing stocks
INSERT INTO historical_prices (symbol, date, open, high, low, close, volume) VALUES
-- AAPL data
('AAPL', '2025-06-20', 148.50, 151.20, 147.80, 150.25, 52000000),
('AAPL', '2025-06-21', 150.25, 152.00, 149.50, 151.75, 48000000),
('AAPL', '2025-06-22', 151.75, 153.25, 150.90, 152.40, 51000000),
('AAPL', '2025-06-23', 152.40, 154.00, 151.20, 153.80, 55000000),
('AAPL', '2025-06-24', 153.80, 155.20, 152.50, 154.60, 49000000),
('AAPL', '2025-06-25', 154.60, 156.00, 153.20, 155.40, 53000000),
('AAPL', '2025-06-26', 155.40, 157.80, 154.80, 156.90, 47000000),

-- GOOGL data
('GOOGL', '2025-06-20', 2750.00, 2820.50, 2740.00, 2835.50, 28000000),
('GOOGL', '2025-06-21', 2835.50, 2890.00, 2815.20, 2875.25, 25000000),
('GOOGL', '2025-06-22', 2875.25, 2920.80, 2850.60, 2905.70, 30000000),
('GOOGL', '2025-06-23', 2905.70, 2950.00, 2885.40, 2920.15, 27000000),
('GOOGL', '2025-06-24', 2920.15, 2975.60, 2900.80, 2945.30, 32000000),
('GOOGL', '2025-06-25', 2945.30, 2980.20, 2925.50, 2960.80, 29000000),
('GOOGL', '2025-06-26', 2960.80, 3000.00, 2940.20, 2985.40, 31000000),

-- TSLA data
('TSLA', '2025-06-20', 795.60, 825.40, 790.20, 820.40, 45000000),
('TSLA', '2025-06-21', 820.40, 850.80, 815.50, 835.75, 42000000),
('TSLA', '2025-06-22', 835.75, 860.20, 828.90, 845.60, 48000000),
('TSLA', '2025-06-23', 845.60, 870.50, 840.30, 855.20, 50000000),
('TSLA', '2025-06-24', 855.20, 880.00, 850.40, 865.80, 46000000),
('TSLA', '2025-06-25', 865.80, 885.60, 860.20, 875.45, 44000000),
('TSLA', '2025-06-26', 875.45, 895.20, 870.80, 885.90, 47000000),

-- MSFT data
('MSFT', '2025-06-20', 298.45, 308.20, 295.80, 305.80, 35000000),
('MSFT', '2025-06-21', 305.80, 312.50, 302.40, 310.25, 32000000),
('MSFT', '2025-06-22', 310.25, 318.00, 307.60, 315.75, 38000000),
('MSFT', '2025-06-23', 315.75, 322.40, 312.90, 320.15, 36000000),
('MSFT', '2025-06-24', 320.15, 325.80, 317.50, 323.60, 34000000),
('MSFT', '2025-06-25', 323.60, 328.20, 320.40, 326.85, 37000000),
('MSFT', '2025-06-26', 326.85, 332.50, 324.20, 330.40, 33000000),

-- META data
('META', '2025-06-20', 320.15, 328.75, 318.50, 325.90, 38000000),
('META', '2025-06-21', 325.90, 332.40, 322.80, 330.25, 35000000),
('META', '2025-06-22', 330.25, 338.60, 327.90, 335.75, 40000000),
('META', '2025-06-23', 335.75, 342.20, 332.40, 340.15, 37000000),
('META', '2025-06-24', 340.15, 346.80, 337.50, 344.60, 39000000),
('META', '2025-06-25', 344.60, 350.20, 341.90, 348.75, 36000000),
('META', '2025-06-26', 348.75, 355.40, 346.20, 352.90, 41000000);

-- Show completion status
SELECT 'Historical prices table recreated successfully!' as status,
       COUNT(*) as total_records,
       COUNT(DISTINCT symbol) as unique_symbols
FROM historical_prices; 