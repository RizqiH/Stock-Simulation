-- Migration: Add historical prices and advanced orders tables
-- Created: 2024

-- Historical prices table for charting
CREATE TABLE IF NOT EXISTS historical_prices (
    id INT AUTO_INCREMENT PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,
    date DATE NOT NULL,
    open DECIMAL(10,2) NOT NULL,
    high DECIMAL(10,2) NOT NULL,
    low DECIMAL(10,2) NOT NULL,
    close DECIMAL(10,2) NOT NULL,
    volume BIGINT NOT NULL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_symbol_date (symbol, date),
    INDEX idx_date (date),
    UNIQUE KEY unique_symbol_date (symbol, date)
);

-- Advanced orders table
CREATE TABLE IF NOT EXISTS orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    stock_symbol VARCHAR(10) NOT NULL,
    order_type ENUM('MARKET', 'LIMIT', 'STOP_LOSS', 'TAKE_PROFIT') NOT NULL,
    side ENUM('BUY', 'SELL') NOT NULL,
    quantity INT NOT NULL,
    price DECIMAL(10,2) DEFAULT NULL,
    stop_price DECIMAL(10,2) DEFAULT NULL,
    status ENUM('PENDING', 'EXECUTED', 'CANCELLED', 'EXPIRED') DEFAULT 'PENDING',
    executed_price DECIMAL(10,2) DEFAULT NULL,
    executed_at TIMESTAMP NULL,
    expires_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_symbol (stock_symbol),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);

-- Insert sample historical data for existing stocks
INSERT INTO historical_prices (symbol, date, open, high, low, close, volume) VALUES
-- AAPL historical data (last 30 days)
('AAPL', DATE_SUB(CURDATE(), INTERVAL 30 DAY), 148.50, 152.30, 147.80, 151.20, 82345600),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 29 DAY), 151.20, 153.40, 149.90, 150.80, 78234500),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 28 DAY), 150.80, 154.20, 149.30, 153.10, 89765400),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 27 DAY), 153.10, 155.60, 151.40, 154.90, 92187300),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 26 DAY), 154.90, 157.30, 153.20, 156.70, 87654200),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 25 DAY), 156.70, 158.90, 155.10, 157.40, 95432100),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 24 DAY), 157.40, 159.80, 156.30, 158.20, 88976500),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 23 DAY), 158.20, 160.50, 157.10, 159.60, 91234700),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 22 DAY), 159.60, 161.30, 158.40, 160.90, 86543200),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 21 DAY), 160.90, 162.70, 159.80, 161.50, 94876300),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 20 DAY), 161.50, 163.20, 160.20, 162.80, 87654300),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 19 DAY), 162.80, 164.50, 161.90, 163.40, 92187400),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 18 DAY), 163.40, 165.10, 162.30, 164.70, 89543600),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 17 DAY), 164.70, 166.20, 163.80, 165.30, 91876500),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 16 DAY), 165.30, 167.40, 164.50, 166.80, 88765400),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 15 DAY), 166.80, 168.90, 165.60, 167.50, 94321700),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 14 DAY), 167.50, 169.30, 166.20, 168.40, 87654800),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 13 DAY), 168.40, 170.60, 167.10, 169.20, 92456300),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 12 DAY), 169.20, 171.80, 168.30, 170.50, 89876500),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 11 DAY), 170.50, 172.40, 169.60, 171.30, 91234800),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 10 DAY), 171.30, 173.70, 170.40, 172.90, 88543600),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 9 DAY), 172.90, 174.50, 171.80, 173.60, 94567200),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 8 DAY), 173.60, 175.30, 172.40, 174.80, 87234500),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 7 DAY), 174.80, 176.90, 173.90, 175.40, 92876300),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 6 DAY), 175.40, 177.20, 174.50, 176.10, 89654700),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 5 DAY), 176.10, 178.60, 175.30, 177.80, 91432800),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 4 DAY), 177.80, 179.40, 176.90, 178.50, 88765400),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 3 DAY), 178.50, 180.20, 177.60, 179.30, 94321600),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 2 DAY), 179.30, 181.80, 178.40, 180.90, 87654200),
('AAPL', DATE_SUB(CURDATE(), INTERVAL 1 DAY), 180.90, 182.50, 179.80, 181.60, 92456700),

-- GOOGL historical data
('GOOGL', DATE_SUB(CURDATE(), INTERVAL 30 DAY), 2420.50, 2458.30, 2398.80, 2441.20, 1234560),
('GOOGL', DATE_SUB(CURDATE(), INTERVAL 29 DAY), 2441.20, 2467.40, 2422.90, 2453.80, 1187450),
('GOOGL', DATE_SUB(CURDATE(), INTERVAL 28 DAY), 2453.80, 2489.20, 2431.30, 2476.10, 1298740),
('GOOGL', DATE_SUB(CURDATE(), INTERVAL 27 DAY), 2476.10, 2502.60, 2454.40, 2489.90, 1356730),
('GOOGL', DATE_SUB(CURDATE(), INTERVAL 26 DAY), 2489.90, 2518.30, 2467.20, 2506.70, 1421850),
('GOOGL', DATE_SUB(CURDATE(), INTERVAL 25 DAY), 2506.70, 2534.90, 2485.10, 2521.40, 1187640),
('GOOGL', DATE_SUB(CURDATE(), INTERVAL 24 DAY), 2521.40, 2548.80, 2499.30, 2537.20, 1345290),
('GOOGL', DATE_SUB(CURDATE(), INTERVAL 23 DAY), 2537.20, 2565.50, 2516.10, 2552.60, 1256730),
('GOOGL', DATE_SUB(CURDATE(), INTERVAL 22 DAY), 2552.60, 2578.30, 2531.40, 2567.90, 1423180),
('GOOGL', DATE_SUB(CURDATE(), INTERVAL 21 DAY), 2567.90, 2592.70, 2546.80, 2581.50, 1189540),

-- MSFT historical data
('MSFT', DATE_SUB(CURDATE(), INTERVAL 30 DAY), 248.50, 255.30, 246.80, 252.20, 28345600),
('MSFT', DATE_SUB(CURDATE(), INTERVAL 29 DAY), 252.20, 258.40, 249.90, 256.80, 31234500),
('MSFT', DATE_SUB(CURDATE(), INTERVAL 28 DAY), 256.80, 262.20, 254.30, 260.10, 29765400),
('MSFT', DATE_SUB(CURDATE(), INTERVAL 27 DAY), 260.10, 266.60, 257.40, 264.90, 32187300),
('MSFT', DATE_SUB(CURDATE(), INTERVAL 26 DAY), 264.90, 270.30, 262.20, 268.70, 27654200),
('MSFT', DATE_SUB(CURDATE(), INTERVAL 25 DAY), 268.70, 274.90, 266.10, 272.40, 35432100),
('MSFT', DATE_SUB(CURDATE(), INTERVAL 24 DAY), 272.40, 278.80, 270.30, 276.20, 28976500),
('MSFT', DATE_SUB(CURDATE(), INTERVAL 23 DAY), 276.20, 282.50, 274.10, 280.60, 31234700),
('MSFT', DATE_SUB(CURDATE(), INTERVAL 22 DAY), 280.60, 286.30, 278.40, 284.90, 26543200),
('MSFT', DATE_SUB(CURDATE(), INTERVAL 21 DAY), 284.90, 290.70, 282.80, 288.50, 34876300),

-- TSLA historical data
('TSLA', DATE_SUB(CURDATE(), INTERVAL 30 DAY), 198.50, 205.30, 194.80, 202.20, 42345600),
('TSLA', DATE_SUB(CURDATE(), INTERVAL 29 DAY), 202.20, 208.40, 199.90, 206.80, 38234500),
('TSLA', DATE_SUB(CURDATE(), INTERVAL 28 DAY), 206.80, 212.20, 204.30, 210.10, 49765400),
('TSLA', DATE_SUB(CURDATE(), INTERVAL 27 DAY), 210.10, 216.60, 207.40, 214.90, 52187300),
('TSLA', DATE_SUB(CURDATE(), INTERVAL 26 DAY), 214.90, 220.30, 212.20, 218.70, 47654200),
('TSLA', DATE_SUB(CURDATE(), INTERVAL 25 DAY), 218.70, 224.90, 216.10, 222.40, 55432100),
('TSLA', DATE_SUB(CURDATE(), INTERVAL 24 DAY), 222.40, 228.80, 220.30, 226.20, 48976500),
('TSLA', DATE_SUB(CURDATE(), INTERVAL 23 DAY), 226.20, 232.50, 224.10, 230.60, 51234700),
('TSLA', DATE_SUB(CURDATE(), INTERVAL 22 DAY), 230.60, 236.30, 228.40, 234.90, 46543200),
('TSLA', DATE_SUB(CURDATE(), INTERVAL 21 DAY), 234.90, 240.70, 232.80, 238.50, 54876300); 